[mcu]

serial: #Find serial
restart_method:command

[printer]
kinematics: corexy
max_velocity: 600
max_accel: 25000
max_z_velocity: 30
max_z_accel: 1000
square_corner_velocity: 10

##################################
# XY Steppers
##################################

## Left stepper
## E0 Driver spot
[stepper_x] 
step_pin: PD5
dir_pin: PD6
enable_pin: !PD4
rotation_distance: 40
microsteps: 32
full_steps_per_rotation:200
endstop_pin: 

position_min: -5
position_endstop: 165
position_max: 165

homing_speed: 25
homing_retract_dist: 5
homing_positive_dir: true

[tmc2209 stepper_x]
uart_pin: PD7
interpolate: False
run_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 0

## Left stepper
## Z-MOT Driver spot
[stepper_y]
step_pin: PD14 
dir_pin: PD13
enable_pin: !PD15
rotation_distance: 40
microsteps: 32
full_steps_per_rotation:200
endstop_pin: 

position_min: 0
position_endstop: 170
position_max: 170

homing_speed: 25
homing_retract_dist: 5
homing_positive_dir: true

[tmc2209 stepper_y]
uart_pin: Pd10
interpolate: False
run_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 0

##################################
# Z Steppers
##################################
## Z0 - Front Left
##  E2-MOT Driver spot
[stepper_z]
step_pin: PE2
dir_pin: !PE4
enable_pin: !PE3
gear_ratio: 3:1
rotation_distance: 40    
microsteps: 32
endstop_pin: 
##  Z-position of nozzle (in mm) to z-endstop trigger point relative to print surface (Z0)
##  (+) value = endstop above Z0, (-) value = endstop below
##  Increasing position_endstop brings nozzle closer to the bed
##  After you run Z_ENDSTOP_CALIBRATE, position_endstop will be stored at the very end of your config
position_endstop: -0.5
## All builds use same Max Z
position_max: 100
position_min: -30
homing_speed: 8.0 # Leadscrews are slower than 2.4, 10 is a recommended max.
second_homing_speed: 3
homing_retract_dist: 3

[tmc2209 stepper_z]
uart_pin: PC15
interpolate: False
run_current: 0.6
sense_resistor: 0.110
stealthchop_threshold: 0

##  Z1 - Rear Center
##  E3-MOT Driver Spot
[stepper_z1]
step_pin: PD12
dir_pin: PC4
enable_pin: !PE8
gear_ratio: 3:1
rotation_distance: 40
microsteps: 32

[tmc2209 stepper_z1]
uart_pin: PA15
interpolate: False
run_current: 0.6
sense_resistor: 0.110
stealthchop_threshold: 0

##  Z2 - Front Right
##  E4-MOT Driver Spot
[stepper_z2]
step_pin: PE1
dir_pin: PE0
enable_pin: !PC5
gear_ratio: 3:1
rotation_distance: 40
microsteps: 32

[tmc2209 stepper_z2]
uart_pin: PD11
interpolate: False
run_current: 0.6
sense_resistor: 0.110
stealthchop_threshold: 0

##################################
# Extruder
##################################

##  E1-MOT Driver Spot
[extruder]
step_pin: PE6
dir_pin: PC13
enable_pin: !PE5
rotation_distance: 22.6789511
gear_ratio: 50:10
microsteps: 32
full_steps_per_rotation: 200   
nozzle_diameter: 0.400
filament_diameter: 1.75
heater_pin: PB15
sensor_type: Generic 3950
sensor_pin: PC1
min_temp: 10
max_temp: 270
max_power: 1.0
min_extrude_temp: 170
control = pid
pid_kp = 26.213
pid_ki = 1.304
pid_kd = 131.721

[tmc2209 extruder]
uart_pin: PC14
interpolate: false
run_current: 0.5
sense_resistor: 0.110
stealthchop_threshold: 0

##################################
# Bed
##################################

[heater_bed]
heater_pin: PB4
sensor_type: Generic 3950
sensor_pin: PC0
##  Adjust max_power so it doesn't exceed the SSR rating. The Omron G3NA-210B-DC5 SSR is rated at 4 amps without a heatsink.
##  The formula is "4 / (Wattage_of_bed_heater / Mains_voltage) = max_power"
##  If max_power is greater than 1.0, use 1.0
max_power: 0.6
min_temp: 0
max_temp: 120
control: pid
pid_kp: 58.437
pid_ki: 2.347
pid_kd: 363.769

##################################
# Probe (from LH stinger config)
##################################

[xz_dockable_probe]
dock_pin: 			# Pin wired to the Z endstop mounted on the extrusion
dock_x: 15		    	# X position of nozzle where the toolhead and probe magnets align
park_delta_x: -15		# X travel required to remove the probe from the dock (relative to dock_x)
detach_delta_x: 15		# X travel required to insert the probe into the dock  (relative to dock_x)
z_speed: 30
xy_speed:160
z_hop: 12			    # Z travel required to clear dock
#hook_commands: False 	# optional setting to disable the auto attach/detach features. Default is True

# Physical measurement references: 
#        Nozzle positioned at ~112mm from the left face of the Z pillar = G1 X0
#        Bed 0,0 = nozzle at G1 X18 Y38 
home_xy_position: 150,138 # probe coordinates 

[probe]
pin:^PA0			# Pin wired to Toolhead QuickDraw Probe   
x_offset: -32
y_offset: 0
samples: 1
sample_retract_dist: 5
samples_result: median
samples_tolerance: 0.02
samples_tolerance_retries: 3
speed: 5
lift_speed: 25

##### QD Probe Macros ####

[gcode_macro QD_home_tilt]
gcode:
    G28 lock_probe=1
    Z_TILT_ADJUST
    G28 Z
     
[gcode_macro QD_dock]
gcode:
    probe_detach force=1

[gcode_macro QD_attach]
gcode:
    probe_attach

[gcode_macro QD_latch]
gcode:
    probe_lock

[gcode_macro QD_mesh]
description: Heat bed, attach probe, home, mesh, detach probe
gcode:

    {% set BED_TEMP = params.BED_TEMP|default(0) %}
    M190 S{BED_TEMP}
    QD_home_tilt
    bed_mesh_calibrate


##################################
# Fans
##################################

[fan]
##  Part Cooling Fan
pin: PA13
kick_start_time: 0.5
off_below: 0.10

[idle_timeout]
timeout: 1800

[safe_z_home]
##  XY Location of the Z Endstop Switch
##  Update -10,-10 to the XY coordinates of your endstop pin 
##  (such as 157,305) after going through Z Endstop Pin
##  Location Definition step.
home_xy_position:-10,-10
speed:100
z_hop:10

[z_tilt]

z_positions:
    -37.087, 34.935
    227.925, 80
    197.08, 34.935
points:
    10, 5
    80, 130
    150, 5
    
speed: 200
horizontal_move_z: 10
retries: 5
retry_tolerance: 0.0075

#####################################################################
#   Macros (From Voron Config)
#####################################################################

[gcode_macro PRINT_START]
#   Use PRINT_START for the slicer starting script - PLEASE CUSTOMISE THE SCRIPT
gcode:
    M117 Homing...                 ; display message
    G28
    Z_TILT_ADJUST
    G28

    ##  Uncomment for for your size printer:
    #--------------------------------------------------------------------
    ##  Uncomment for 250mm build
    #G0 X125 Y125 Z30 F3600

    ##  Uncomment for 300 build
    #G0 X150 Y150 Z30 F3600

    ##  Uncomment for 350mm build
    #G0 X175 Y175 Z30 F3600
    #--------------------------------------------------------------------

   

[gcode_macro PRINT_END]
#   Use PRINT_END for the slicer ending script - please customise for your slicer of choice
gcode:
    # safe anti-stringing move coords
    {% set th = printer.toolhead %}
    {% set x_safe = th.position.x + 20 * (1 if th.axis_maximum.x - th.position.x > 20 else -1) %}
    {% set y_safe = th.position.y + 20 * (1 if th.axis_maximum.y - th.position.y > 20 else -1) %}
    {% set z_safe = [th.position.z + 2, th.axis_maximum.z]|min %}
    
    SAVE_GCODE_STATE NAME=STATE_PRINT_END

    M400                           ; wait for buffer to clear
    G92 E0                         ; zero the extruder
    G1 E-2.0 F3600                 ; retract filament
    
    TURN_OFF_HEATERS
    
    G90                                      ; absolute positioning
    G0 X{x_safe} Y{y_safe} Z{z_safe} F20000  ; move nozzle to remove stringing
    G0 X{th.axis_maximum.x//2} Y{th.axis_maximum.y - 2} F3600  ; park nozzle at rear
    M107                                     ; turn off fan
    
    BED_MESH_CLEAR

    # The purpose of the SAVE_GCODE_STATE/RESTORE_GCODE_STATE
    # command pair is to restore the printer's coordinate system
    # and speed settings since the commands above change them.
    # However, to prevent any accidental, unintentional toolhead
    # moves when restoring the state, explicitly set MOVE=0.
    RESTORE_GCODE_STATE NAME=STATE_PRINT_END MOVE=0

